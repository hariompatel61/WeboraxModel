name: "ðŸŽ¬ Generate & Upload Video"

on:
  workflow_dispatch:
    inputs:
      topic:
        description: "Video topic (leave empty for auto-generated)"
        required: false
        default: ""
        type: string

  schedule:
    - cron: "30 1 * * *"   # 7:00 AM IST daily
    - cron: "30 13 * * *"  # 7:00 PM IST daily

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸŽµ Install FFmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg

      - name: ðŸ“¦ Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ”‘ Setup credentials
        run: |
          # Write .env from secrets
          cat > .env << 'ENVEOF'
          LLM_PROVIDER=bytez
          BYTEZ_API_KEY=${{ secrets.BYTEZ_API_KEY }}
          BYTEZ_MODEL=Qwen/Qwen3-4B
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL=gemini-2.0-flash
          AIMLAPI_KEY=${{ secrets.AIMLAPI_KEY }}
          CHATGPT_IMAGE_API_KEY=${{ secrets.CHATGPT_IMAGE_API_KEY }}
          VIDEO_DURATION=30
          VIDEO_WIDTH=1080
          VIDEO_HEIGHT=1920
          VIDEO_FPS=24
          NARRATOR_VOICE=en-US-GuyNeural
          YOUTUBE_CLIENT_SECRET_FILE=Client_secret.json
          YOUTUBE_CATEGORY=24
          MADE_FOR_KIDS=false
          PLAYLIST_ID=${{ secrets.PLAYLIST_ID }}
          ENVEOF

          # Write Client_secret.json from secret
          echo '${{ secrets.CLIENT_SECRET_JSON }}' > Client_secret.json

          # Write YouTube token from secret (base64 encoded)
          if [ -n "${{ secrets.YOUTUBE_TOKEN_B64 }}" ]; then
            echo '${{ secrets.YOUTUBE_TOKEN_B64 }}' | base64 -d > youtube_token.pickle
            echo "Successfully restored youtube_token.pickle"
          else
            echo "::error::YOUTUBE_TOKEN_B64 secret is MISSING! Did you follow Step 1?"
            exit 1
          fi

      - name: ðŸŽ¬ Run Video Bot
        run: python run_bot.py
        env:
          PYTHONDONTWRITEBYTECODE: 1

      - name: ðŸ“Š Upload generated video (on success)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: generated-video-${{ github.run_number }}
          path: outputs/video/
          retention-days: 7
